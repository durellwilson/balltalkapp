rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isAthlete() {
      return isSignedIn() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'athlete';
    }
    
    // Users collection
    match /users/{userId} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Chat messages collection
    match /messages/{messageId} {
      allow read, write: if request.auth != null;
    }
    
    // Conversations collection
    match /conversations/{conversationId} {
      allow read, write: if request.auth != null && 
        (resource == null || resource.data.participants[request.auth.uid] == true);
    }
    
    // Message requests collection
    match /messageRequests/{requestId} {
      allow read: if isSignedIn() && 
                   (resource.data.fromUserId == request.auth.uid || 
                    resource.data.toUserId == request.auth.uid);
      
      allow create: if isSignedIn() && request.resource.data.fromUserId == request.auth.uid;
      
      allow update: if isSignedIn() && resource.data.toUserId == request.auth.uid;
      
      allow delete: if isSignedIn() && 
                     (resource.data.fromUserId == request.auth.uid || 
                      resource.data.toUserId == request.auth.uid);
    }
    
    // Fan Group Payments
    match /fanGroupPayments/{groupId} {
      allow read: if isSignedIn() && (
                    // Group admin (athlete)
                    resource.data.athleteId == request.auth.uid ||
                    // Members don't need payment info
                    exists(/databases/$(database)/documents/conversations/$(groupId)) &&
                    get(/databases/$(database)/documents/conversations/$(groupId)).data.participants.hasAny([request.auth.uid])
                  );
      
      allow create: if isSignedIn() && isAthlete() && request.resource.data.athleteId == request.auth.uid;
      
      allow update: if isSignedIn() && resource.data.athleteId == request.auth.uid;
      
      allow delete: if false; // Payments should never be deleted
    }
    
    // Fan Group Subscriptions
    match /fanGroupSubscriptions/{subscriptionId} {
      allow read: if isSignedIn() && (
                    // User's own subscription
                    resource.data.userId == request.auth.uid ||
                    // Group owner (athlete)
                    resource.data.athleteId == request.auth.uid
                  );
      
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      
      allow update: if isSignedIn() && (
                      // User can update own subscription (e.g., cancel)
                      resource.data.userId == request.auth.uid ||
                      // Group owner can update subscriptions (e.g., approve/reject)
                      resource.data.athleteId == request.auth.uid
                    );
      
      allow delete: if false; // Subscriptions should be marked as inactive instead of deleted
    }
    
    // Typing indicators collection
    match /typing/{typingId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isSignedIn() && request.resource.data.userId == request.auth.uid;
    }
    
    // Test collections can be read and written by anyone during testing
    match /test/{document=**} {
      allow read, write: if true;
    }
    
    // Allow all other operations for authenticated users (for backward compatibility)
    match /{document=**} {
      allow read, write: if isSignedIn();
    }
    
    match /verifications/{document} {
      allow read, write: if request.auth != null;
    }
    
    match /songs/{document} {
      allow read: if true;
      allow write: if request.auth != null;
    }
  }
}
